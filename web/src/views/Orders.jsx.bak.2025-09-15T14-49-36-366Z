import React,{useEffect,useState} from "react";
async function j(u){ const r=await fetch(u); if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText)); return r.json(); }
export default function Orders(){
  const [orders,setOrders]=useState([]),[err,setErr]=useState("");
  useEffect(()=>{ (async()=>{ setErr(""); for(const u of ["/api/my/orders","/api/orders?scope=me","/api/orders"]){ try{ const d=await j(u); setOrders(d.orders||d||[]); return; }catch{} } setOrders([]); })().catch(e=>setErr(String(e.message||e))); },[]);
  return (<div className="max-w-3xl mx-auto px-3 py-4">
    <h1 className="text-xl font-semibold mb-3">Meine Bestellungen</h1>
    {err && <div className="mb-3 p-2 rounded bg-rose-900/20 border border-rose-700 text-rose-300 text-sm">{err}</div>}
    {orders.length===0 ? <div className="text-zinc-400">Noch keine Bestellungen.</div> :
      <div className="space-y-3">
        {orders.map(o=>{ const items=(o.items)||(()=>{ try{ return JSON.parse(o.cart_json||"{}").items||[]; }catch{return [];} })();
          return (<div key={o.id||o.order_id} className="p-3 rounded-2xl bg-zinc-900/60 border border-zinc-800">
            <div className="flex items-center gap-2 mb-2"><div className="font-medium">#{o.id||o.order_id}</div><div className="text-xs text-zinc-500">• {o.status||"—"}</div></div>
            {items.length===0 ? <div className="text-zinc-400 text-sm">Keine Positionen gefunden.</div> :
              <ul className="list-disc pl-5 space-y-1 text-sm">{items.map((it,idx)=><li key={idx}>{(it.qty||1)}× {it.title} · {Number((it.price||0)*(it.qty||1)).toFixed(2)} €</li>)}</ul>}
          </div>);
        })}
      </div>}
  </div>);
}